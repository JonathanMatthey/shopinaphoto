/*1309400747,176820662*/

if (window.CavalryLogger) { CavalryLogger.start_js(["gh604"]); }

var NewHigh={reset:function(){this.initialized=false;},ensureInitialized:function(){if(this.initialized)return;this.button=DOM.scry(document.body,'a.stream_header_button')[0];this.composer=DOM.scry(document.body,'div.UIComposer')[0];this.buttonArea=DOM.scry(this.composer,'div.UIComposer_ButtonArea')[0];this.initialized=true;},showComposer:function(a){this.ensureInitialized();if(this.composer){CSS.show(this.composer);UIComposer.focusInstance(this.composer.id);var b=UIComposer.getInstance(this.composer.id);b&&b.loadAttachment(parseInt(a,10));}this.button&&CSS.hide(this.button);},hideComposer:function(b){this.ensureInitialized();if(this.composer){var a=UIComposer.getInstance(this.composer.id);if(!b){a&&a.initialized&&a.blur();CSS.hide(this.composer);this.button&&CSS.show(this.button);}else{a&&a.initialized&&a.loadAttachment(0);CSS.show(this.composer);this.buttonArea&&CSS.hide(this.buttonArea);}}}};
function HomeSideNav(){this.parent.construct(this);}HomeSideNav.extend('SideNav');HomeSideNav.STATUS_UPDATE_APP_ID=2915120374;HomeSideNav.ajaxPipeEndpoints={'/ajax/home/feed.php':true,'/ajax/home/group.php':true,'/ajax/home/questions.php':true};HomeSideNav.prototype={init:function(c,a,b,d){this.parent.init(c,a,b,d);this.path=this.equivalentPath(URI.getRequestURI().getPath());this.shouldFocusComposer=false;this.sortableNavs=[];this.hasEdit=false;this.inEdit=false;this.urlToKeyMap={};Arbiter.subscribe(NavigationMessage.PREFETCH,this.prefetch.bind(this));Arbiter.subscribe(NavigationMessage.INTERNAL_LOADING_BEGIN,this.internalLoadNotify.bind(this));Arbiter.subscribe(NavigationMessage.INTERNAL_LOADING_COMPLETED,this.internalLoadNotify.bind(this));},addToURLMap:function(a){this.urlToKeyMap=merge(this.urlToKeyMap,a);},equivalentPath:function(a){return (a=='/home.php')?'/':a;},resolveKey:function(b,c){var a=Base64.encode(c.getPath());if(this.urlToKeyMap[a])return this.urlToKeyMap[a];if(c.getPath()=='/games'||c.getPath()=='/games/'){b='games';}else if(b&&this.isEvent(b)){b='events';}else if(this.isGroup(c)){return false;}else if(this.path!=this.equivalentPath(c.getPath())||this.domain!=c.getDomain())return false;return b;},handlePageTransition:function(c,b){var a=this.getEndpoint(b);if(HomeSideNav.ajaxPipeEndpoints[a])c.ap=1;var d=null;if(window.UIIntentionalStream&&window.UIIntentionalStream.instances){if(UIIntentionalStream.instances.nile)d=UIIntentionalStream.instances.nile;UIIntentionalStream.instances.global&&UIIntentionalStream.instances.global.unload();UIIntentionalStream.instances.friends&&UIIntentionalStream.instances.friends.unload();UIIntentionalStream.instances.blade&&UIIntentionalStream.instances.blade.unload();}d&&d.unload();return this.parent.handlePageTransition(c,b);},prefetch:function(b,a){a.prefetch=true;this.loadKey(a.sk,true);this.parent.handlePageTransition(a,a.sk);},shouldRefreshRightColumn:function(c,b){if(!c){var a=this.getEndpoint(b);return a=='/ajax/home/groups.php'||a=='/ajax/home/group.php';}else{var d=this.isFeedSwitcher(b)&&this.isFeedSwitcher(this.selectedKey);return (this.isTopLevelNode(this.loadingNode)&&!d)||this.isFriendListFilter(b);}},isFeedSwitcher:function(a){return (a=='lf')||(a=='h');},isFriendListFilter:function(a){return a.substring(0,3)=='fl_';},isEvent:function(a){return a.substring(0,6)=='event_';},isGroup:function(a){return a.getPath().substring(0,8)=='/groups/';},navigationComplete:function(){DOMScroll.scrollTo(document.documentElement,false);return this.parent.navigationComplete();},focusComposer:function(){NewHigh.showComposer(HomeSideNav.STATUS_UPDATE_APP_ID);},internalLoadNotify:function(b,a){return this._setKeyLoadIndicator(a.key||null,b==NavigationMessage.INTERNAL_LOADING_BEGIN);},initSideNav:function(a,b,c){this.addEndpoints(a);this.setStarButtons(b);this.addToURLMap(c||{});},initSeeAllDialog:function(a,b){this.addEndpoints(a);this.setStarButtons(b);this.setSeeAllEditMode();this.setLinkClickEvents(b);},setStarButtons:function(a){DOM.scry(a,'span.buttonWrap').each((function(d){var e=Parent.byClass(d,'homeSideNavItem');var g=DOM.find(e,'a.item label.nonEditButton');var f=DOM.find(g,'input');var b=DOM.find(e,'div.editButton li.star');var c=DOM.find(b,'span.itemLabel');if(DOM.contains($('pinnedNav'),e)){f.title=_tx("Unstar");DOM.setContent(c,_tx("Unstar"));}else{f.title=_tx("Star");DOM.setContent(c,_tx("Star"));}CSS.show(d);Event.listen(g,'click',this._handleStar.bind(this));Event.listen(b,'click',this._handleStar.bind(this));}).bind(this));},setLinkClickEvents:function(a){DOM.scry(a,'a.item').each((function(b){Event.listen(b,'click',this._handleLinkClick.bind(this));}).bind(this));},setSeeAllEditMode:function(){var b=ge('pagelet_bookmark_seeall');if(b){var a=DOM.find(b,'table.bookmarksSeeAllGrid');CSS.conditionClass(a,'editMode',this.inEdit);}},toggleEditMode:function(b){var a=$('sideNav');if(!this.hasEdit){this.setLinkClickEvents(a);this.hasEdit=true;}this.inEdit=!this.inEdit;Bootloader.loadComponents('sortable-side-nav-js',this._toggleEditMode.bind(this,a,b.getAttribute('data-endpoint')));},removeGroup:function(a){this._removeItem('li.key-group_'+a);if(this.removedSideItem&&CSS.hasClass(this.removedSideItem,'selectedItem'))goURI(URI.getRequestURI());},_removeItem:function(c){this.removedSideItem=null;var a;if((a=DOM.scry($('pinnedNav'),c))&&a.length){this.removedSideItem=a[0];DOM.remove(a[0]);}else{if((a=DOM.scry($('dynamicNav'),c))&&a.length){this.removedSideItem=a[0];DOM.remove(a[0]);}var b=ge('pagelet_bookmark_seeall');if(b&&(a=DOM.scry(b,c))&&a.length)DOM.remove(a[0]);}},_toggleEditMode:function(d,a){if(this.inEdit){var e=DOM.scry(d,'.droppableNav .uiSideNav');for(var c=0;c<e.length;c++){this.sortableNavs[c]=new SortableSideNav(e[c],a,!!Parent.byClass(e[c],'droppableNav'),true);this.sortableNavs[c].beginEdit();if(c>0)this.sortableNavs[c-1].linkNav(this.sortableNavs[c]);}}else{for(var b=0;b<this.sortableNavs.length;b++)this.sortableNavs[b].endEdit();this.sortableNavs=[];}CSS.conditionClass(d,'editMode',this.inEdit);this.setSeeAllEditMode();},_setKeyLoadIndicator:function(b,a){if(!b)return;var c=DOM.scry(this.root,'li.key-'+b);if(c.length==0)return;CSS.conditionClass(c[0],'loading',a);},_refreshDynamicPagelet:function(){UIPagelet.loadFromEndpoint('BookmarkNavigationPagelet','pagelet_bookmark_nav');},_removeHoverIE:function(b){CSS.addClass(b,'unhover');var a=Event.listen(b,'mouseover',function(){CSS.removeClass(b,'unhover');a.remove();});},_prependItem:function(b,a){if(ua.ie()){this._removeHoverIE(a);if(ua.ie()===8){DOM.remove(a);(function(){DOM.prependContent(b,a);}).defer(5);return;}}DOM.prependContent(b,a);},_appendItem:function(b,a){if(ua.ie()){this._removeHoverIE(a);if(ua.ie()===8){DOM.remove(a);(function(){DOM.appendContent(b,a);}).defer(5);return;}}DOM.appendContent(b,a);},_handleStar:function(event){var l=event.getTarget();var d=Parent.byClass(l,'homeSideNavItem');var f=DOM.find(d,'a.item label.nonEditButton input');var b=DOM.find(d,'div.editButton li.star span.itemLabel');var c;var i=false;var h=$('pinnedNav');var a=$('dynamicNav');if(DOM.contains(h,d)){var k=DOM.scry(a,'.uiSideNav');this._prependItem(k[0],d);f.title=_tx("Star");DOM.setContent(b,_tx("Star"));c='/ajax/bookmark/delete/';}else{if(ge('pagelet_bookmark_seeall')&&DOM.contains(ge('pagelet_bookmark_seeall'),d))i=true;this._appendItem(DOM.find(h,'.uiSideNav'),d);f.title=_tx("Unstar");DOM.setContent(b,_tx("Unstar"));c='/ajax/bookmark/add/';}var g=DOM.scry(d,'div.editButton div.openToggler');if(g.length){CSS.removeClass(g[0],'openToggler');CSS.removeClass(DOM.find(g[0],'a.selected'),'selected');}var j=new AsyncRequest().setURI(c).setData({id:d.id.replace('navItem_','')});if(i)j.setHandler(this._refreshDynamicPagelet.bind(this));j.send();if(this.sortableNavs)for(var e=0;e<this.sortableNavs.length;e++)this.sortableNavs[e].resetSortableGroup();CSS.conditionShow(DOM.scry(a,'.uiHeader')[0],DOM.scry(a,'.uiSideNav')[0].childNodes.length);return false;},_handleLinkClick:function(event){return !this.inEdit;}};
function pagecache_log_feed_tracking(a){Bootloader.loadComponents('dom-collect',function(){var c=DOM.scry(document.body,'ul.uiStream li.uiStreamStory');var b=c.map(function(d){return collect_data_attrib(d,'ft');});b=b.filter(count).map(JSON.stringify);if(!b.length)return;new AsyncRequest().setMethod('POST').setURI('/ajax/feed_tracking_pagecache.php').setReadOnly(true).setData({ft:$A(b),async:a}).send();});}
var HomeNavController={init:function(){Arbiter.subscribe(PresenceMessage.getArbiterMessageType('nav_update_counts'),this._updateCounts.bind(this));},updateCounts:function(b){for(var a=0;a<b.length;a++)Arbiter.inform(NavigationMessage.NAVIGATION_COUNT_UPDATE,b[a]);},expandGroups:function(){var a=ge('groupSideNavWrapper');if(a){CSS.addClass(a,'expandedMode');CSS.hide(DOM.find($('moreGroupsLink'),'.count'));new AsyncRequest('/ajax/groups/navigation/more_link/more_link.php').setMethod('post').setReadOnly(false).send();}},collapseGroups:function(){var a=ge('groupSideNavWrapper');if(a)CSS.removeClass(a,'expandedMode');},expandApps:function(){var a=ge('bookmarks_menu');if(a)CSS.addClass(a,'expandedMode');},collapseApps:function(){var a=ge('bookmarks_menu');if(a)CSS.removeClass(a,'expandedMode');},_lastSeenKey:null,resetGroupsAndApps:function(a){a=a||null;if(!a||!a.selected_key||a.selected_key!=this._lastSeenKey){this.collapseGroups();this.collapseApps();if(ge('groupSideNavWrapper'))UIPagelet.loadFromEndpoint('GroupsNavigationPagelet','pagelet_groups_nav',a);}this._lastSeenKey=(a&&a.selected_key)?a.selected_key:null;},addSection:function(a,c,b,d){SideNav.getInstance().addEndpoints(a);SideNav.getInstance().updateCloseButtons(c,b);SideNav.getInstance().addToURLMap(d||{});},_groupIDs:[],initGroupCounts:function(a,b){this._groupIDs=a;if(a&&a.length>0)Arbiter.subscribe(PresenceMessage.getArbiterMessageType('group_nav_update'),this._updateGroupCounts.bind(this));},_refreshGroupCounts:function(a){new AsyncRequest().setURI('/ajax/groups/navigation/update_counts/update_counts.php').setData({group_ids:a,nav_group_ids:this._groupIDs}).setMethod('post').send();},_updateGroupCounts:function(event,a){this._refreshGroupCounts([a.obj.group_id]);},_updateCounts:function(event,a){this.updateCounts(a.obj.items);}};
onloadRegister(function(){Event.listen(document.documentElement,'submit',function(b){var a=b.getTarget().getElementsByTagName('*');for(var c=0;c<a.length;c++)if(a[c].getAttribute('required')&&Input.isEmpty(a[c])){a[c].focus();return false;}},Event.Priority.URGENT);});
var UIIntentionalStreamMessage={SET_AUTO_INSERT:'UIIntentionalStream/setAutoInsert',UPDATE_STREAM:'UIIntentionalStreamRefresh/updateStream',REFRESH_STREAM:'UIIntentionalStreamRefresh/refreshStream',UPDATE_AUTOREFRESH_CONFIG:'UIIntentionalStream/updateAutoRefreshConfig',UPDATE_HTML_CONTENT:'UIIntentionalStream/updateHtmlContent',UPDATE_LAST_REFRESH_TIME:'UIIntentionalStream/updateLastRefreshTime'};
function UIIntentionalStream(i,d,g,h,b,j,k,c,f,a,e,l){if(!i)throw new Error('UIIntentionalStream instantiated with no root.');copy_properties(this,{id:i.id,root:i,instanceName:d,newest:g,oldest:h,firstLoadIDs:c,shouldShowHidden:false,defaultFilter:b,currentFilterKey:a,sourceType:j,streamStoryCount:k,maxUnseenStoryCount:f,lastSeenTime:e,tntMode:l,hasPendingRefresh:false,pauseAutoInsert:false,unseenStoryCount:0,streamHeader:$('pagelet_stream_header'),error:DOM.scry(i,'div.UIIntentionalStream_Error')[0],pager:DOM.scry(i,'div.uiMorePager')[0],streamContent:DOM.find(i,'.UIIntentionalStream_Content'),requestNum:0,scrollLoadCount:1,maxScrollLoadCount:1,scrollListener:null,mostRecentHeader:null,topPosition:67});this.setUpStreamHeader();if(this.streamStoryCount>0)this.updateLiveFeedCount(this.streamStoryCount);onleaveRegister(this.unload.bind(this));if(!UIIntentionalStream.instances)UIIntentionalStream.instances={};UIIntentionalStream.instances[d]=this;UIIntentionalStream.instance=this;this.setupAutoInsert();this.setupSubscriptions();}UIIntentionalStream.prototype.subscribeToComposerPublish=function(){this.subscriptions.push(Arbiter.subscribe('composer/publish',function(event,a){if(a.streamStory)this.addContent(a.streamStory,500);}.bind(this)));};UIIntentionalStream.prototype.setupSubscriptions=function(){this.subscriptions=[];this.subscribeToComposerPublish();if(!this.tntMode){this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,this.updateStream.bind(this)));this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,this.refreshStream.bind(this)));}};UIIntentionalStream.prototype.tearDownSubscriptions=function(){if(!this.subscriptions)return;this.subscriptions.forEach(Arbiter.unsubscribe);if(this.scrollListener){this.scrollListener.remove();this.scrollListener=null;}};UIIntentionalStream.prototype.unload=function(){this.tearDownSubscriptions();UIIntentionalStream.instance=null;UIIntentionalStream.instances[this.instanceName]=null;this.clearScrollLoader(true);window.disableScrollLoad=null;};UIIntentionalStream.getInstance=function(a){return UIIntentionalStream.instances[a];};UIIntentionalStream.prototype._getUpdateInsertType=function(){if(this.isOnNewHighlights())return UIIntentionalStream.REFRESH_COUNT;return UIIntentionalStream.REFRESH_PREPEND;};UIIntentionalStream.prototype.updateStream=function(a){if(a!=UIIntentionalStreamMessage.UPDATE_STREAM||this.hasPendingRefresh||this.isAutoRefreshPaused()||this.tntMode)return;this.loadNewer({showLoader:false,ignoreSelf:true,insertType:this._getUpdateInsertType()});};UIIntentionalStream.prototype.clearScrollLoader=function(a){if(this.currentScrollListener){this.currentScrollListener.remove();this.currentScrollListener=null;}if(a||this.scrollLoadCount>=this.maxScrollLoadCount)window.disableScrollLoad=true;};UIIntentionalStream.prototype.loadOlderPosts=function(b){var a={filter:this.getCurrentFilterKey(),oldest:this.oldest,last_seen_time:this.lastSeenTime,scroll_count:this.scrollLoadCount};a=merge(a,b);this.loadWithParams(a);};UIIntentionalStream.prototype.loadMostRecent=function(){var a={filter:UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED,firstload:true,scroll_count:1};this.loadWithParams(a);};UIIntentionalStream.prototype.switchToMostRecent=function(a){this.oldest=null;this.currentFilterKey=UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED;if(a){this.scrollListener=Event.listen(window,'scroll',this.checkScroll.bind(this));this.mostRecentHeader=a;}};UIIntentionalStream.prototype.checkScroll=function(){var a=Vector2.getElementPosition(this.mostRecentHeader,'viewport');if(a.y<this.topPosition&&this.scrollListener){this.scrollListener.remove();this.scrollListener=null;new AsyncSignal('ajax/feed/sticky_state.php',{}).send();}};UIIntentionalStream.prototype.loadTopNews=function(b){var a=$('topnews_placeholder');if(a)CSS.addClass(a.parentNode,'async_saving');DOMScroll.scrollTo(new Vector2(0,0,'document'),true,true);UIPagelet.loadFromEndpoint('TopNewsPagelet','topnews_placeholder',[],{usePipe:true,replayable:true,append:true});b.onclick=function(){DOMScroll.scrollTo(new Vector(0,0,'document'),true,true);return false;};};UIIntentionalStream.prototype.loadWithParams=function(a){var b=DOM.scry(this.root,'div.fbStreamPager.hasMorePosts')[0];if(b){if(CSS.hasClass(b,'async_saving'))return;CSS.addClass(b,'async_saving');}UIPagelet.loadFromEndpoint('/pagelet/home/morestories.php','home_stream',a,{usePipe:true,replayable:true,append:true});};UIIntentionalStream.prototype.setScrollLoadCount=function(a){this.maxScrollLoadCount=a;};UIIntentionalStream.prototype.loadMoreOnScroll=function(b,a,c){if(window.disableScrollLoad)return;var e=function(){if(window.disableScrollLoad)return;var g={delay_load_count:a};if(this.scrollLoadCount==1&&this.firstLoadIDs&&this.firstLoadIDs.length>0)g=merge(g,{first_load_ids:this.firstLoadIDs,show_hidden:this.shouldShowHidden,query_time:c});if(this.tntMode&&this.scrollLoadCount==1&&this.getCurrentFilterKey()==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS){this.loadMostRecent();}else this.loadOlderPosts(g);}.bind(this);var f=DOM.scry(this.root,'ul.uiStream li.genericStreamStory');if(!f.length)return;var d=f[f.length-b-1];if(d){this.currentScrollListener=new OnVisible(d,e,null,0,{detect_speed:this.scrollLoadCount>1});}else e();};UIIntentionalStream.prototype.updateTimeRange=function(a,b){if(!this.newest||this.newest<a)this.newest=a;if(!this.oldest||(b&&(b<this.oldest)))this.oldest=b;};UIIntentionalStream.prototype.updatePageCache=function(){if(this.getCurrentFilterKey()==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS||this.tntMode)return;this.loadNewer({bundleAsync:true,showLoader:false,ignoreReqNum:true});};UIIntentionalStream.prototype.getID=function(){return this.id;};UIIntentionalStream.prototype.showPositioned=function(a,c,b){if(c==UIIntentionalStream.REFRESH_APPEND){DOM.appendContent(this.root,a);}else if(c==UIIntentionalStream.REFRESH_PREPEND){DOM.prependContent(this.root,a);}else if(c==UIIntentionalStream.REFRESH_EXPAND)DOM.insertAfter($(b.expandStoryID),a);CSS.setStyle(a,'display','block');if(a.src)a.src=a.src;};UIIntentionalStream.prototype.getCurrentFilterKey=function(){if(this.currentFilterKey)return this.currentFilterKey;var a=this.getCurrentParams();if(a&&a.filter){this.currentFilterKey=a.filter;}else if(this.defaultFilter)this.currentFilterKey=this.defaultFilter;return this.currentFilterKey;};UIIntentionalStream.prototype.loadOlder=function(a){a=a||{};if(!this.oldest)return;var b=this.getCurrentParams();b.oldest=this.oldest;this.refresh(UIIntentionalStream.REFRESH_APPEND,b,a);return this;};UIIntentionalStream.prototype.loadNewer=function(b){if(!this.newest)return;b=b||{};var a=this.getCurrentParams();a.newest=this.newest;if(b.ignoreSelf)a.ignore_self=true;a.load_newer=true;var c=coalesce(b.insertType,UIIntentionalStream.REFRESH_PREPEND);this.refresh(c,a,b);return this;};UIIntentionalStream.prototype.getCurrentParams=function(){var a={};var b=URI.getMostRecentURI().getQueryData();if(b.sk)b.filter=b.sk;var c=this.getValidParams();if(c){c.forEach(function(d){a[d]=b[d];});}else a=b;return a;};UIIntentionalStream.prototype.setHomeFilter=function(a){this._homeFilter=a;};UIIntentionalStream.prototype.setHomeFilterLoading=function(a){if(this._homeFilter)this._homeFilter.setLoading(a);};UIIntentionalStream.prototype.refresh=function(l,b,h){Arbiter.inform(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME);this.currentFilterKey=b.filter;if(b.filter==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED){this.currentFilterKey=this.defaultFilter;}else if(b.filter==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS||b.filter===UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED)this.defaultFilter=this.currentFilterKey;h=h||{};var j=++this.requestNum;var a=coalesce(h.bundleAsync,false);var k=coalesce(h.showLoader,true);var f=this.instanceName;var e=function(m){UIIntentionalStream.getInstance(f).handleResponse(j,l,m,h);};var c=function(m){UIIntentionalStream.getInstance(f).handleError(j,l,m,h);};var d=function(m){UIIntentionalStream.getInstance(f).handleFinally(l,b.filter,m);};if(!(b.request_type=l))b.request_type='none';if(b.filter){h.show_hidden=b.show_hidden?b.show_hidden:false;}else h.show_hidden=this.shouldShowHidden;var g=true;if(b.newest)g=false;b=copy_properties(this.getCurrentParams(),b);this.hasPendingRefresh=true;var i;if(l==UIIntentionalStream.REFRESH_APPEND&&k)i=this.pager;new AsyncRequest().setURI(this.getEndpoint()).setReadOnly(true).setOption('retries',0).setMethod(this.getRefreshMethod()).setData(b).setOption('bundle',a).setReplayable(g).setHandler(e).setStatusElement(i).setErrorHandler(c).setFinallyHandler(d).send();if(l==UIIntentionalStream.REFRESH_TRANSITION){hide(this.pager);this.clearScrollLoader(true);this.oldest=this.newest=null;}if(k)this.setHomeFilterLoading(true);};UIIntentionalStream.prototype.addContent=function(a,b){this.addContentPrepend(a,b);};UIIntentionalStream.prototype.addContentPrepend=function(a,b){if(a.length){$A(a).reverse().forEach(function(h){this.addContentPrepend(h,b);}.bind(this));return;}var d;var f=Vector2.getScrollPosition().y;var c=Vector2.getElementPosition(this.streamContent).y;var g=this.scrollOnPrepend&&f>=c;if(g){var e=function(h){var i=DOM.find(h,'^li.uiStreamStory');if(!i)return;DataStore.set(i,'origHeight',i.offsetHeight);Event.listen(h,'load',function(){var j=DataStore.get(i,'origHeight');if(i.offsetHeight!=j){window.scrollBy(0,i.offsetHeight-j);DataStore.set(i,'origHeight',i.offsetHeight);}});};d=animation.insert.curry(this.streamContent,a,function(i,h){DOM.prependContent(i,h);window.scrollBy(0,h.offsetHeight);DOM.scry(h,'img').forEach(e);});}else d=animation.prependInsert.curry(this.streamContent,a);if(b){setTimeout(d,b);}else d();};UIIntentionalStream.prototype.addContentAppend=function(a){DOM.appendContent(this.streamContent,a);};UIIntentionalStream.getStoriesByAssoc=function(a){return DOM.scry(UIIntentionalStream.instance.root,'div.aid_'+a);};UIIntentionalStream.prototype.handleResponse=function(c,e,d,b){var a=d.isReplay()||b.ignoreReqNum;return this.handleResponsePayload(c,e,d.getPayload(),a,b);};UIIntentionalStream.prototype.handleResponsePayload=function(e,g,d,b,c){c=c||{};if(is_empty(d))return;if(d.streamHeader){DOM.setContent(this.streamHeader,HTML(d.streamHeader));if(this.isOnNewsFeedFilter())this.setUpStreamHeader();NewHigh.reset();}if(d.autoRefreshConfig)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,d.autoRefreshConfig);this.setHomeFilterLoading(false);if(g==UIIntentionalStream.REFRESH_EXPAND){var f=DOM.find($(c.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.hide(f);CSS.removeClass(f,'UIIntentionalStory_CollapsedStoriesLoading');}if(this.error)hide(this.error);if(!b&&e!=this.requestNum)return;if('show_hidden' in c)this.shouldShowHidden=c.show_hidden;if('newestStoryTime' in d&&d.newestStoryTime>this.newest)this.newest=d.newestStoryTime;if('oldestStoryTime' in d&&(!this.oldest||d.oldestStoryTime<this.oldest))this.oldest=d.oldestStoryTime;if('streamStoryCount' in d)this.updateLiveFeedCount(d.streamStoryCount);if(d.html){var a=HTML(d.html).getNodes();switch(g){case UIIntentionalStream.REFRESH_COUNT:if(d.storyCount)this.updateLiveFeedCount(d.storyCount,true);break;case UIIntentionalStream.REFRESH_PREPEND:this.addContentPrepend(a);break;case UIIntentionalStream.REFRESH_APPEND:this.addContentAppend(a);this.clearScrollLoader(true);break;case UIIntentionalStream.REFRESH_TRANSITION:DOM.setContent(this.streamContent,a);DOMScroll.scrollTo(new Vector2(0,0,"document"),false);break;case UIIntentionalStream.REFRESH_EXPAND:DOM.insertAfter($(c.expandStoryID),a);break;case UIIntentionalStream.DELAYED_STREAM:if(!Quickling.isCacheHit())this.addContentAppend(a);break;}Arbiter.inform(UIIntentionalStreamMessage.UPDATE_HTML_CONTENT);}};UIIntentionalStream.prototype.updateLiveFeedCount=function(c,b){var d=(this.unseenStoryCount==0||!b);if(b){this.unseenStoryCount+=c;}else this.unseenStoryCount=c;if(this.unseenStoryCount>0&&this.liveFeedCount){var a='';if(this.unseenStoryCount>this.maxUnseenStoryCount){a=this.maxUnseenStoryCount+'+';}else a=this.unseenStoryCount.toString();DOM.setContent(this.liveFeedCount,HTML(a));if(d)CSS.show(this.liveFeedBubble);}};UIIntentionalStream.prototype.handleError=function(c,f,d,b){if(!d.isReplay()&&c!=this.requestNum)return;this.setHomeFilterLoading(false);var a=d.getError();if(a==1357001)AsyncResponse.defaultErrorHandler(d);if(f==UIIntentionalStream.REFRESH_EXPAND){var e=DOM.find($(b.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.removeClass(e,'UIIntentionalStory_CollapsedStoriesLoading');}if(!b.delayLoadCount&&f!=UIIntentionalStream.REFRESH_PREPEND&&this.error)CSS.setStyle(this.error,'display','block');};UIIntentionalStream.prototype.handleFinally=function(b,a){if(b==UIIntentionalStream.REFRESH_TRANSITION){PageTransitions.transitionComplete();Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED);}this.hasPendingRefresh=false;};UIIntentionalStream.prototype.getValidParams=function(){return UIIntentionalStream.VALID_PARAMS;};UIIntentionalStream.prototype.getEndpoint=function(){return UIIntentionalStream.ENDPOINT;};UIIntentionalStream.prototype.getRefreshMethod=function(){return UIIntentionalStream.REFRESH_METHOD;};UIIntentionalStream.prototype.isOnNewHighlights=function(){var a=this.getCurrentFilterKey();return (a==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS||(a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED&&this.defaultFilter==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS));};UIIntentionalStream.prototype.isLiveStreamBox=function(){var a=this.getCurrentFilterKey();return a&&a.indexOf(UIIntentionalStream.FEED_FILTER_KEY_LIVE_STREAM_BOX)==0;};UIIntentionalStream.prototype.isOnNewsFeedFilter=function(){var a=this.getCurrentFilterKey();return (a==UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED||a==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS||a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED);};UIIntentionalStream.prototype.setupAutoInsert=function(){Arbiter.subscribe(UIIntentionalStreamMessage.SET_AUTO_INSERT,UIIntentionalStream.setAutoInsert);};UIIntentionalStream.setAutoInsert=function(b,a){if(b!=UIIntentionalStreamMessage.SET_AUTO_INSERT)return;var c=UIIntentionalStream.instance;if(c)c.pauseAutoInsert=a.pause;};UIIntentionalStream.prototype.isAutoRefreshPaused=function(){if(this.isOnNewHighlights()||this.isLiveStreamBox())return false;return this.pauseAutoInsert;};UIIntentionalStream.prototype.setUpStreamHeader=function(){if(!this.streamHeader)return;this.liveFeedBubble=DOM.scry(this.streamHeader,'span.uiBubbleCount')[0];if(!this.liveFeedBubble)return;this.liveFeedCount=DOM.scry(this.liveFeedBubble,'span.number')[0];if(!this.maxUnseenStoryCount)this.maxUnseenStoryCount=UIIntentionalStream.MAX_UNSEEN_STORY_COUNT;};UIIntentionalStream.prototype.refreshStream=function(e,a){if(e!=UIIntentionalStreamMessage.REFRESH_STREAM)return;var c=this.getCurrentFilterKey();if(this.isOnNewsFeedFilter()&&a.shouldOverride)c=UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS;var f=(c==UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS);var b={filter:c};if(f)b.pending=f;var d={filter:c};this.refresh(UIIntentionalStream.REFRESH_TRANSITION,b,d);};copy_properties(UIIntentionalStream,{ANIMATION_DURATION:300,REFRESH_METHOD:'GET',REFRESH_TRANSITION:1,REFRESH_PREPEND:2,REFRESH_APPEND:3,REFRESH_COUNT:4,REFRESH_EXPAND:5,DELAYED_STREAM:6,FEED_FILTER_KEY_NEW_HIGHLIGHTS:'h',FEED_FILTER_KEY_NEWS_FEED:'lf',FEED_FILTER_KEY_DUAL_NEWS_FEED:'nf',FEED_FILTER_KEY_LIVE_STREAM_BOX:'pub',VALID_PARAMS:['filter','show_hidden'],ENDPOINT:'/ajax/intent.php',MAX_UNSEEN_STORY_COUNT:300});
function UIIntentionalStreamRefresh(a,b){copy_properties(this,{isAutoRefreshing:false,lastRefresh:new Date().getTime()});UIIntentionalStreamRefresh.instance=this;this.setAutoRefreshConfig(a);this.updateConfigHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,this.updateAutoRefreshConfig.bind(this));this.updateRefreshTimeHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME,this.updateLastRefreshTime.bind(this));onleaveRegister(this.unload.bind(this));this.userActivity();this.uaToken=UserActivity.subscribe(this.userActivity.bind(this));this.autoRefreshInterval=setInterval(this.checkAutoPageRefresh.bind(this),this.checkAutoRefreshTimeInterval);this.enableAutoRefresh(b);Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,LiveTimer.loop.bind(LiveTimer,true));Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,LiveTimer.loop.bind(LiveTimer,true));if(this.usePresence)UIIntentionalStreamRefresh.presenceRegister();}copy_properties(UIIntentionalStreamRefresh,{_presenceInit:false,DISABLE_AUTOREFRESH_TIME:4*60*1000,CHECK_AUTOREFRESH_INTERVAL:5*60*1000,AUTOREFRESH_INACTIVE_TIME:30*60*1000,HIGHLIGHTS_OVERRIDE_TIME:360*60*1000});UIIntentionalStreamRefresh.presenceRegister=function(){if(UIIntentionalStreamRefresh._presenceInit)return true;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('feedpub'),UIIntentionalStreamRefresh.handleNewStoryMessage);UIIntentionalStreamRefresh._presenceInit=true;};UIIntentionalStreamRefresh.prototype.updateAutoRefreshConfig=function(b,a){if(b==UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG)this.setAutoRefreshConfig(a);};UIIntentionalStreamRefresh.prototype.updateLastRefreshTime=function(a){if(a==UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME)this.lastRefresh=new Date().getTime();};UIIntentionalStreamRefresh.prototype.setAutoRefreshConfig=function(a){a=a||{};var b=24*60*60*1000;if(!this.storyInterval)this.storyInterval=coalesce(a.story_interval,null);this.allowAutoRefresh=coalesce(a.allow_auto_refresh,false);this.inactiveThreshold=coalesce(a.inactive_threshold,0);this.activeRefreshTime=coalesce(a.fast_refresh_rate,b);this.inactiveRefreshTime=coalesce(a.slow_refresh_rate,b);this.allowPolling=coalesce(a.allow_polling,false);this.refreshFactor=coalesce(a.refresh_factor,10);this.minRefreshInterval=coalesce(a.min_refresh_interval,60*1000);this.usePresence=coalesce(a.use_presence,false);this.disableAutoRefreshTime=coalesce(a.disable_autorefresh_time,UIIntentionalStreamRefresh.DISABLE_AUTOREFRESH_TIME);this.checkAutoRefreshTimeInterval=coalesce(a.check_autorefresh_time_interval,UIIntentionalStreamRefresh.CHECK_AUTOREFRESH_INTERVAL);this.autoRefreshInactiveTime=coalesce(a.autorefresh_inactive_time,UIIntentionalStreamRefresh.AUTOREFRESH_INACTIVE_TIME);this.highlightsOverrideTime=coalesce(a.highlights_override_time,UIIntentionalStreamRefresh.HIGHLIGHTS_OVERRIDE_TIME);return this;};UIIntentionalStreamRefresh.prototype.unload=function(){this.enableAutoRefresh(false);this.cleanupRefreshInterval();UserActivity.unsubscribe(this.uaToken);this.updateConfigHandler&&Arbiter.unsubscribe(this.updateConfigHandler);this.updateRefreshTimeHandler&&Arbiter.unsubscribe(this.updateRefreshTimeHandler);};UIIntentionalStreamRefresh.prototype.userActivity=function(){var a=this.isInactive();this.lastActivity=(new Date().getTime());this.isAutoRefreshing=true;if(a&&this.canAutoRefresh())this.runAutoRefresh();return true;};UIIntentionalStreamRefresh.prototype.isInactive=function(){return this.getMSSinceLastActivity()>this.inactiveThreshold;};UIIntentionalStreamRefresh.prototype.getMSSinceLastActivity=function(){return (new Date().getTime())-this.lastActivity;};UIIntentionalStreamRefresh.prototype.getMSSinceLastRefresh=function(){return (new Date().getTime())-this.lastRefresh;};UIIntentionalStreamRefresh.prototype.getRefreshInterval=function(){if(this.isInactive()){return this.inactiveRefreshTime;}else if(this.storyInterval!=null){var a=this.storyInterval*this.refreshFactor;return Math.max(a,this.activeRefreshTime);}else return this.activeRefreshTime;};UIIntentionalStreamRefresh.prototype.canAutoRefresh=function(){return this.isAutoRefreshing&&this.allowAutoRefresh;};UIIntentionalStreamRefresh.handleNewStoryMessage=function(b,a){if(b!=PresenceMessage.getArbiterMessageType('feedpub'))return;Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cancelUpdate=function(){if(this.updateTask){clearTimeout(this.updateTask);this.updateTask=null;}};UIIntentionalStreamRefresh.prototype.runUpdatePoll=function(){this.updateTask=null;if(this.canAutoRefresh())this.runAutoRefresh();};UIIntentionalStreamRefresh.prototype.runAutoRefresh=function(){var a=50;if(this.getMSSinceLastRefresh()>=this.minRefreshInterval-a)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);this.schedulePoll(this.getRefreshInterval());};UIIntentionalStreamRefresh.prototype.schedulePoll=function(a){this.cancelUpdate();if(this.allowPolling)this.updateTask=setTimeout(this.runUpdatePoll.bind(this),a);};UIIntentionalStreamRefresh.prototype.enableAutoRefresh=function(b,c){this.isAutoRefreshing=b;if(b){var a=c?0:this.getRefreshInterval();this.schedulePoll(a);}else this.cancelUpdate();};UIIntentionalStreamRefresh.prototype.checkAutoPageRefresh=function(){if(!this.allowAutoRefresh)return;if(this.isAutoRefreshing&&(this.getMSSinceLastActivity()>this.disableAutoRefreshTime))this.isAutoRefreshing=false;if(this.getMSSinceLastRefresh()<this.autoRefreshInactiveTime)return;var a=this.getMSSinceLastActivity();if(a>this.autoRefreshInactiveTime){var b=(a>this.highlightsOverrideTime);Arbiter.inform(UIIntentionalStreamMessage.REFRESH_STREAM,{shouldOverride:b});}};UIIntentionalStreamRefresh.prototype.cleanupRefreshInterval=function(){if(this.autoRefreshInterval){clearInterval(this.autoRefreshInterval);this.autoRefreshInterval=null;}};
function tz_calculate(f){var a=new Date();var b=a.getTimezoneOffset()/30;var e=a.getTime()/1000;var d=Math.round((f-e)/1800);var c=Math.round(b+d)%48;if(c==0){return 0;}else if(c>24){c-=Math.ceil(c/48)*48;}else if(c<-28)c+=Math.ceil(c/-48)*48;return c*30;}function tz_autoset(d,c){if(!d||undefined==c)return;if(window.tz_autoset.calculated)return;window.tz_autoset.calculated=true;var b=-tz_calculate(d);if(b!=c){var a='/ajax/autoset_timezone_ajax.php';new AsyncRequest().setURI(a).setData({gmt_off:b}).setErrorHandler(bagofholding).setTransportErrorHandler(bagofholding).setOption('suppressErrorAlerts',true).send();}}